<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SIMPLE STANDARD SCHOOL, JOS â€” SS3 Online Examination</title>

<!-- jsPDF for PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
:root{--accent:#0b63d6;--accent2:#0ea5a4}
body{margin:0;font-family:Times new Roman, Helvetica, sans-serif;background:linear-gradient(135deg,#eef6ff,#f7fff5);color:#0b1220}
header{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:white;box-shadow:0 2px 8px rgba(10,20,40,.06)}
.brand{display:flex;align-items:center;gap:12px}
.logo{
  width:60px;
  height:60px;
  border-radius:8px;
  object-fit:cover;
  background:none;
}
nav{display:flex;gap:10px}
nav button{background:transparent;border:1px solid var(--accent);padding:8px 12px;border-radius:8px;color:var(--accent);cursor:pointer}
.container{max-width:1100px;margin:28px auto;padding:20px}
.card{background:white;padding:20px;border-radius:12px;box-shadow:0 8px 30px rgba(12,24,60,.06)}
.center{display:grid;place-items:center}
.big{font-size:34px;font-weight:800}
.marquee{overflow:hidden;margin-top:10px}
.marquee .text{display:inline-block;white-space:nowrap;animation:marquee 16s linear infinite}
@keyframes marquee{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}
.btn{background:linear-gradient(90deg,var(--accent),var(--accent2));color:white;border:0;padding:10px 16px;border-radius:10px;cursor:pointer}
.btn.secondary{background:white;color:var(--accent);border:1px solid #e6eefc}
.grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
.select,input,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eefc}
.qnav{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
.qbox{padding:8px;border-radius:6px;border:1px solid #eef5ff;text-align:center;cursor:pointer}
.qbox.answered{background:linear-gradient(90deg,var(--accent2),var(--accent));color:white}
.questions .q{margin-bottom:14px}
.small{font-size:13px;color:#334155}
.footer{padding:14px;text-align:center;color:#475569}
.hidden{display:none}
@media(max-width:920px){.grid{grid-template-columns:1fr}}

/* background slideshow for welcome page */
#page1 { position: relative; overflow: hidden; }
#page1::before {
  content: "";
  position: absolute;
  inset: 0;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  opacity: 0;
  transition: opacity 1s ease-in-out;
  animation: fadeSlide 25s infinite;
  z-index: 0;
}
@keyframes fadeSlide {
  0%,20% { background-image: url("backimage1.png"); opacity:.7;}
  20.1%,40% { background-image: url("backimage2.png"); opacity:.7;}
  40.1%,60% { background-image: url("backimage3.png"); opacity:1;}
  60.1%,80% { background-image: url("backimage4.png"); opacity:.7;}
  80.1%,100% { background-image: url("backimage5.png"); opacity:.7;}
}
#page1 *{ position: relative; z-index: 1; }

/* welcome text */
.big {
  font-family: "Cooper Black", "Times New Roman", serif;
  font-size: 70px;
  font-weight: 900;
  color: navy;
  -webkit-text-stroke: 2px white;
  text-transform: uppercase;
  letter-spacing: 3px;
  text-shadow: 4px 4px 8px rgba(0,0,0,.4), 0 0 15px rgba(255,255,255,.5);
}
.school-name {
  font-family: "Cooper Black", "Times New Roman", serif;
  font-size: 50px;
  font-weight: 900;
  color: navy;
  -webkit-text-stroke: 1px white;
  text-shadow: 0 0 6px rgba(255,255,255,0.4);
}

/* admin forms */
.admin-form { display:flex; gap:8px; margin-bottom:8px; align-items:center; }
.admin-form > * { flex: 1 1 auto; }
.admin-col { display:grid; gap:8px; grid-template-columns:1fr 1fr; }
</style>
</head>
<body>
<header>
  <div class="brand">
    <img id="siteLogo" src="./logo.png" alt="School Logo" class="logo">
    <div>
      <div id="headerSchool" style="font-weight:700">SIMPLE STANDARD SCHOOL, JOS</div>
      <div class="small">SS3 Online Examination Portal</div>
    </div>
  </div>
  <nav>
    <button id="homeBtn">Home</button>
    <button id="adminBtn">Admin</button>
  </nav>
</header>

<div class="container">
  <!-- PAGE 1 -->
  <section id="page1" class="card center">
    <div class="big">WELCOME TO</div>
    <div style="margin-top:18px">
      <img src="./logo.png" alt="School Logo" style="width:150px;height:150px;object-fit:contain;border-radius:12px;">
    </div>
    <div class="school-name" style="margin-top:8px;">SIMPLE STANDARD SCHOOL, JOS</div>

    <div class="marquee"><div class="text">Simple Standard School SS 3 Online Examination Site, 2025/2026 â€” Good luck to all candidates!</div></div>

    <div style="margin-top:16px"><button id="toStudentSelect" class="btn">Proceed to Examination</button></div>
    <div class="small" style="margin-top:18px;opacity:.9">BAITUSSALAM</div>
  </section>

  <!-- PAGE 2: Student selection -->
  <section id="page2" class="card hidden">
    <h3>Select Student</h3>
    <p class="small">Choose your name from the list</p>
    <select id="studentSelect" class="select"></select>
    <div style="display:flex;justify-content:flex-end;margin-top:12px;gap:8px">
      <button id="toHomeFromStudents" class="btn secondary">Home</button>
      <button id="toSubjectPage" class="btn">Proceed</button>
    </div>
  </section>

  <!-- PAGE 3: Subject selection -->
  <section id="page3" class="card hidden">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="display:flex;align-items:center;gap:12px">
        <img src="./logo.png" class="logo" alt="">
        <div>
          <div style="font-weight:700">SIMPLE STANDARD SCHOOL, JOS</div>
          <div class="small">Selected Student: <span id="selectedStudentName"></span> â€” Exam No: <span id="selectedExamNo"></span></div>
        </div>
      </div>
    </div>
    <hr>
    <h4>Select Subject</h4>
    <select id="subjectSelect" class="select"></select>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
      <div class="small">Stream: <span id="studentStream"></span></div>
      <div>
        <button id="backToStudents" class="btn secondary">Back</button>
        <button id="beginExam" class="btn" style="margin-left:8px">Begin Exam</button>
      </div>
    </div>
  </section>

  <!-- PAGE 4: Exam environment -->
  <section id="page4" class="card hidden">
    <div class="grid">
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:700" id="examSubjectTitle">Subject</div>
            <div class="small">Student: <span id="examStudentName"></span> â€” Exam No: <span id="examStudentNo"></span></div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:800;color:#0b63d6" id="timerDisplay">30:00</div>
            <div class="small">Time remaining</div>
          </div>
        </div>

        <hr>
        <div id="questionArea" class="questions"></div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
          <div>
            <button id="prevBlock" class="btn secondary">Previous</button>
            <button id="nextBlock" class="btn" style="margin-left:8px">Next</button>
          </div>
          <div>
            <button id="submitExam" class="btn" style="background:#ef4444">Submit</button>
          </div>
        </div>
      </div>

      <aside>
        <div class="card" style="padding:12px">
          <h4>Question Navigator</h4>
          <div class="qnav" id="qnav"></div>
          <div class="small" style="margin-top:12px">Answered boxes are highlighted. Click a number to jump to that question block.</div>
          <hr style="margin-top:12px"/>
          <div><strong>Instructions</strong>
            <ul class="small">
              <li>20 questions per subject (randomized from question bank).</li>
              <li>5 questions shown at a time.</li>
              <li>Total time: 30 minutes. Auto-submit when time runs out.</li>
            </ul>
          </div>
        </div>
      </aside>
    </div>
  </section>

  <!-- ADMIN PAGE -->
  <section id="admin" class="card hidden">
    <h3>Admin Access</h3>
    <div style="max-width:800px;margin:0 auto;text-align:left">
    
      <!-- Admin login form (will hide after login) -->
      <div id="adminLoginSection">
        <label class="small">Username</label>
        <input id="adminUser" class="select" placeholder="username">
        <label class="small" style="margin-top:8px">Password</label>
        <input id="adminPass" type="password" class="select" placeholder="password">
        <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
          <button id="adminLogin" class="btn">Login</button>
          <button id="adminBack" class="btn secondary">Back</button>
        </div>
      </div>
    
      <!-- Hidden Logout button (will appear after login) -->
      <div id="adminLogoutSection" class="hidden" style="text-align:right;margin-top:10px;">
        <button id="adminLogout" class="btn secondary" style="background:#ef4444;color:white">Logout</button>
        <button id="adminBack2" class="btn secondary">Back</button>
      </div>

      <div id="adminPanel" class="hidden" style="margin-top:14px">

        <h4>Admin Panel</h4>

        <!-- Student management -->
        <div style="margin-bottom:12px">
          <h5>Add / Manage Students</h5>
          <div class="admin-form">
            <input id="newStudentName" placeholder="Student name">
            <input id="newStudentExamNo" placeholder="Exam number" readonly> <!-- make read-only -->
            <select id="newStudentStream" class="select">
              <option value="">-- Select Stream --</option>              
              <option value="Science">Science</option>
              <option value="Social">Social</option>
            </select>
            <button id="addStudentBtn" class="btn">Add Student</button>
          </div>
        </div>

        <!-- Question management -->
        <div style="margin-bottom:12px">
          <h5>Add Question</h5>
          <div class="admin-col" style="margin-bottom:8px">
            <select id="addQSubject" class="select">
              <option>English</option><option>Mathematics</option><option>Physics</option><option>Chemistry</option><option>Biology</option><option>Economics</option><option>Government</option><option>Geography</option><option>Computer Studies</option>
            </select>
            <select id="addQStream" class="select">
              <option value="Both">Both</option>
              <option value="Science">Science</option>
              <option value="Social">Social</option>
            </select>
          </div>
          <input id="newQuestionText" placeholder="Question text">
          <div class="admin-col" style="margin-top:8px">
            <input id="optA" placeholder="Option A">
            <input id="optB" placeholder="Option B">
            <input id="optC" placeholder="Option C">
            <input id="optD" placeholder="Option D">
          </div>
          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <label class="small">Correct option:</label>
            <select id="correctOption" class="select" style="width:120px">
              <option value="0">A</option><option value="1">B</option><option value="2">C</option><option value="3">D</option>
            </select>
            <button id="addQuestionBtn" class="btn">Add Question</button>
            <button id="editQuestionsBtn" class="btn secondary">Edit Questions</button>
          </div>
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
          <select id="adminStudentSelect" class="select" style="min-width:200px"></select>
          <select id="resetSubjectSelect" class="select" style="min-width:180px">
            <option value="">-- Select Subject to Reset --</option>
          </select>
          <button id="resetSubjectBtn" class="btn" style="background:#ef4444;color:white">Reset Subject Attempt</button>
          <button id="examDetailsBtn" class="btn secondary">Exam Details</button>
          <button id="viewResultBtn" class="btn">View Result</button>
          <button id="downloadResultPdf" class="btn">Download PDF</button>
          <button id="exportAllJson" class="btn secondary">Export All Results (JSON)</button>
        </div>


        <div id="resultsTable"></div>
      </div>
    </div>
  </section>

<!-- EDIT QUESTIONS PAGE -->
<section id="editQuestionsPage" class="card hidden">
  <h3>Edit Questions</h3>

  <div style="max-width:800px;margin:0 auto;text-align:left">
    <label class="small">Select Subject</label>
    <select id="editSubjectSelect" class="select"></select>

    <div id="questionListContainer" style="margin-top:20px;"></div>

    <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end">
      <button id="saveQuestionChanges" class="btn">Save Changes</button>
      <button id="backFromEdit" class="btn secondary">Back</button>
    </div>
  </div>
</section>

<div id="examDetailsPage" class="hidden">
  <h2>Exam Details Settings</h2>
  <table id="examDetailsTable" border="1" style="width:100%; border-collapse:collapse;">
    <tr>
      <th>Subject</th>
      <th>Max Attempts</th>
      <th>Duration (Minutes)</th>
      <th>Exam Date</th>
    </tr>
    <!-- rows will be inserted here by JS -->
  </table>

  <div style="margin-top:15px;text-align:right">
    <button id="saveExamDetails" class="btn">Save Settings</button>
    <button id="backToAdmin" class="btn secondary">Back to Admin</button>
  </div>
</div>

<footer class="footer">SIMPLE STANDARD SCHOOL, JOS â€” SS3 Online Exam Portal â€¢ 2025/2026</footer>

<!-- Firebase + app logic -->
<script type="module">
/* ==================== IMPORTANT: Paste your Firebase config below ==================== */
const FIREBASE_CONFIG = {
   apiKey: "AIzaSyAZ13_SN8a-37U9FwdyvogkT3ojzS5CB6M",
   authDomain: "sss-exam-portal.firebaseapp.com",
   projectId: "sss-exam-portal",
   storageBucket: "sss-exam-portal.firebasestorage.app",
   messagingSenderId: "938709811259",
   appId: "1:938709811259:web:329b16d9391b4cd28adc1e"
 };
/* ===================================================================================== */

const logoPath = './logo.png';

/* --------- Firebase imports --------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
import { getFirestore, collection, addDoc, doc, getDocs, query, where, setDoc } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

// init firebase if config provided
let db = null;
if (FIREBASE_CONFIG && FIREBASE_CONFIG.apiKey) {
  const app = initializeApp(FIREBASE_CONFIG);
  db = getFirestore(app);
  console.log('Firebase initialized');
} else {
  console.warn('No Firebase config provided â€” running in local fallback mode only.');
}

/* -------------------- Initial (fallback) data -------------------- */
const ADMIN_CRED = {user:'baitussalam', pass:'756254'};

let STUDENTS = [
  // Science Students
  'Aminu Isyaku','Abubakar Usman Muhammad','Aisha Umar Sabo','Amina Aliyu Musa','Aisha Abdullahi','Fadima Muhammad Auwal',
  'Fatima Haruna Abbas','Fatima Abubakar','Hauwau Shuaibu Musa','Khadija Ibrahim Nasir','Khansau Umar Khamis','Lubabatu O Ibrahim',
  'Mubarak Abbas Shuaibu','Maryam Ahmed Umaru','Rukaiya Salis Adam','Rukayya Abdulkadir Babanta','Rabiatu Abdullahi Abdulaziz',
  'Shuaibu Rabiu Shuaibu','Umar Tanim Muhammad','Umar Bello Adam','Ummahani Bashir Muhammad','Halima Ibrahim Birma','Yusuf Abdullahi Haruna',

  // Social Science Students
  'Abdullahi Alhassan Ismail','Auwal Ibrahim Abubakar','Aisha Ahmad Khalid','Aisha Sani Ibrahim','Aisha Muazu Abubakar',
  'Fadila Musa','Hauwau Kabir Yaro','Hauwau Musa Alhassan','Hafsat Yahya Shehu','Nasiba Khamis Adam','Nuhu Shehu Adam',
  'Nazifi Ibrahim Shehu','Mercy Dadunjit','Ummisalma Hassan','Usman Aliyu Musa','Zulaika Lawan','Uthman Abdulkadir','Ahmad Salihu','Ibrahim Aliyu'
].map((name,i)=>({
  name,
  examNo:`SS3/2025/${1001+i}`,
  stream: i < 23 ? 'Science' : 'Social'
}));

/* ====== Auto-generate exam numbers ====== */

// Utility to get next exam number by stream
function getNextExamNumber(stream) {
  if (!stream) return '';

  // Filter students by stream
  const filtered = STUDENTS.filter(s => s.stream === stream);

  // Extract numeric part of exam numbers, e.g., 1001 from "SS3/2025/1001"
  const numbers = filtered
    .map(s => parseInt(s.examNo.split('/').pop(), 10))
    .filter(n => !isNaN(n));

  // Find max number or start from base
  const lastNum = numbers.length ? Math.max(...numbers) : (stream === 'Science' ? 1000 : 2000);

  // Increment for next
  const nextNum = lastNum + 1;

  // Format with prefix
  return `SS3/2025/${nextNum}`;
}

// Auto-fill exam number when stream is selected
document.addEventListener('DOMContentLoaded', () => {
  const streamSelect = document.getElementById('newStudentStream');
  const examInput = document.getElementById('newStudentExamNo');

  if (streamSelect && examInput) {
    streamSelect.addEventListener('change', () => {
      const stream = streamSelect.value;
      examInput.value = getNextExamNumber(stream);
    });
  }
});

const SCIENCE_SUBJECTS = [
  'English Language',
  'Mathematics',
  'Physics',
  'Chemistry',
  'Geography',
  'Biology',
  'Agricultural Science',
  'Civic Education',
  'Data Processing',
  'Economics',
  'Marketing',
  'Hausa',
  'Islamic Studies'
];

const SOCIAL_SUBJECTS = [
  'Islamic Studies',
  'Hausa',
  'Data Processing',
  'Marketing',
  'Economics',
  'Civic Education',
  'English Language',
  'Mathematics',
  'Geography',
  'Biology',
  'Agricultural Science',
  'Literature in English',
  'Government'
];

// âœ… Dynamically populate Add Question subjects from both arrays
function populateAddQuestionSubjects() {
  const subjectSel = document.getElementById('addQSubject');
  if (!subjectSel) return;
  subjectSel.innerHTML = ''; // clear any hardcoded list
  const subjects = [...new Set([...SCIENCE_SUBJECTS, ...SOCIAL_SUBJECTS])];
  subjects.sort().forEach(sub => {
    const opt = document.createElement('option');
    opt.value = sub;
    opt.textContent = sub;
    subjectSel.appendChild(opt);
  });
}

/* Local (in-memory) question DB used if Firebase not configured */
let QUESTIONS_DB = {};
[...SCIENCE_SUBJECTS, ...SOCIAL_SUBJECTS].forEach(s=>{
  QUESTIONS_DB[s] = [];
});

// Add questions manually for each subject
QUESTIONS_DB["Mathematics"] = [
  { q: "What is 2 + 2?", options: ["2","3","4","5"], answer: "4" },
  { q: "Simplify 10 Ã· 2", options: ["2","5","10","20"], answer: "5" }
];

QUESTIONS_DB["English Language"] = [
  { q: "Choose the correct verb: He ___ to school.", options: ["go","goes","going","gone"], answer: "goes" },
  { q: "What is the plural of 'child'?", options: ["childs","childes","children","child"], answer: "children" }
];

QUESTIONS_DB["Physics"] = [
  { q: "What is the SI unit of force?", options: ["Joule","Newton","Pascal","Watt"], answer: "Newton" },
  { q: "What does a voltmeter measure?", options: ["Voltage","Current","Resistance","Power"], answer: "Voltage" }
];

QUESTIONS_DB["Chemistry"] = [
  { q: "What is the chemical symbol of water?", options: ["H2O","O2","CO2","NaCl"], answer: "H2O" },
  { q: "Which gas supports combustion?", options: ["Oxygen","Carbon dioxide","Nitrogen","Hydrogen"], answer: "Oxygen" }
];

QUESTIONS_DB["Biology"] = [
  { q: "What is 2 + 2?", options: ["2","3","4","5"], answer: "4" },
  { q: "Simplify 10 Ã· 2", options: ["2","5","10","20"], answer: "5" }
];

QUESTIONS_DB["Government"] = [
  { q: "Choose the correct verb: He ___ to school.", options: ["go","goes","going","gone"], answer: "goes" },
  { q: "What is the plural of 'child'?", options: ["childs","childes","children","child"], answer: "children" }
];

QUESTIONS_DB["Literature in English"] = [
  { q: "What is the SI unit of force?", options: ["Joule","Newton","Pascal","Watt"], answer: "Newton" },
  { q: "What does a voltmeter measure?", options: ["Voltage","Current","Resistance","Power"], answer: "Voltage" }
];

QUESTIONS_DB["Civic Education"] = [
  { q: "What is the chemical symbol of water?", options: ["H2O","O2","CO2","NaCl"], answer: "H2O" },
  { q: "Which gas supports combustion?", options: ["Oxygen","Carbon dioxide","Nitrogen","Hydrogen"], answer: "Oxygen" }
];

QUESTIONS_DB["Geography"] = [
  { q: "What is 2 + 2?", options: ["2","3","4","5"], answer: "4" },
  { q: "Simplify 10 Ã· 2", options: ["2","5","10","20"], answer: "5" }
];

QUESTIONS_DB["Agricultural Science"] = [
  { q: "Choose the correct verb: He ___ to school.", options: ["go","goes","going","gone"], answer: "goes" },
  { q: "What is the plural of 'child'?", options: ["childs","childes","children","child"], answer: "children" }
];

QUESTIONS_DB["Data Processing"] = [
  { q: "What is the SI unit of force?", options: ["Joule","Newton","Pascal","Watt"], answer: "Newton" },
  { q: "What does a voltmeter measure?", options: ["Voltage","Current","Resistance","Power"], answer: "Voltage" }
];

QUESTIONS_DB["Economics"] = [
  { q: "What is the chemical symbol of water?", options: ["H2O","O2","CO2","NaCl"], answer: "H2O" },
  { q: "Which gas supports combustion?", options: ["Oxygen","Carbon dioxide","Nitrogen","Hydrogen"], answer: "Oxygen" }
];

QUESTIONS_DB["Marketting"] = [
  { q: "What is 2 + 2?", options: ["2","3","4","5"], answer: "4" },
  { q: "Simplify 10 Ã· 2", options: ["2","5","10","20"], answer: "5" }
];

QUESTIONS_DB["Islamic Studies"] = [
  { q: "Choose the correct verb: He ___ to school.", options: ["go","goes","going","gone"], answer: "goes" },
  { q: "What is the plural of 'child'?", options: ["childs","childes","children","child"], answer: "children" }
];

QUESTIONS_DB["Hausa"] = [
  { q: "What is the SI unit of force?", options: ["Joule","Newton","Pascal","Watt"], answer: "Newton" },
  { q: "What does a voltmeter measure?", options: ["Voltage","Current","Resistance","Power"], answer: "Voltage" }
];

/* Utility */
function el(id){ return document.getElementById(id); }
function show(page){
  [
    el('page1'),
    el('page2'),
    el('page3'),
    el('page4'),
    el('admin'),
    el('examDetailsPage'),
    el('editQuestionsPage')
  ].forEach(p => p?.classList.add('hidden'));
  
  page.classList.remove('hidden');
  window.scrollTo(0,0);
}

/* --------- Firestore helpers --------- */
async function saveStudentToFirestore(student){
  if(!db) return false;
  const col = collection(db, 'students');
  // use examNo as doc id
  await setDoc(doc(db, 'students', student.examNo), student);
  return true;
}
async function fetchAllStudentsFromFirestore(){
  if(!db) return null;
  const snap = await getDocs(collection(db, 'students'));
  const arr = [];
  snap.forEach(d => arr.push(d.data()));
  return arr;
}
async function saveQuestionToFirestore(question){
  if(!db) return false;
  await addDoc(collection(db, 'questions'), question);
  return true;
}
async function fetchAllQuestionsFromFirestore(selectedSubject){
  let arr = [];

  // ðŸ”¹ Try to fetch from Firebase if available
  if (db) {
    try {
      const snap = await getDocs(collection(db, 'questions'));
      snap.forEach(d => arr.push(Object.assign({id: d.id}, d.data())));
      console.log("Loaded questions from Firebase:", arr.length);
    } catch (err) {
      console.warn("Error loading from Firestore:", err);
    }
  }

  // ðŸ”¹ If Firebase is missing or empty, use local fallback
  if (!arr || arr.length === 0) {
    if (selectedSubject && QUESTIONS_DB[selectedSubject]) {
      arr = QUESTIONS_DB[selectedSubject];
      console.log("Loaded local questions for:", selectedSubject, arr.length);
    } else {
      console.warn("No local questions found for:", selectedSubject);
    }
  }

  return arr;
}
async function saveResultToFirestore(result){
  if(!db) return false;
  await addDoc(collection(db, 'results'), result);
  return true;
}
async function fetchResultsForExamNo(examNo){
  if(!db) return null;
  const q = query(collection(db, 'results'), where('examNo','==',examNo));
  const snap = await getDocs(q);
  const arr = [];
  snap.forEach(d => arr.push(d.data()));
  return arr;
}
async function fetchAllResults(){
  if(!db) return null;
  const snap = await getDocs(collection(db,'results'));
  const arr = [];
  snap.forEach(d=>arr.push(d.data()));
  return arr;
}

/* --------- UI wiring & fallback data loading --------- */
const page1 = el('page1'), 
      page2 = el('page2'), 
      page3 = el('page3'), 
      page4 = el('page4'), 
      adminPage = el('admin'),
      editQuestionsPage = el('editQuestionsPage'); // âœ… Add this here
el('homeBtn').addEventListener('click', ()=> show(page1));
// âœ… HOME BUTTON: Automatically logs out admin if logged in
el('homeBtn').addEventListener('click', ()=> {
  // If admin session exists, clear it
  if (sessionStorage.getItem('is_admin_logged_in')) {
    sessionStorage.removeItem('is_admin_logged_in');
    el('adminPanel').classList.add('hidden');
    console.log('Admin session cleared due to Home click.');
  }
  show(page1);
});

// âœ… ADMIN BUTTON: Show admin login or panel depending on session
el('adminBtn').addEventListener('click', ()=>{
  if(sessionStorage.getItem('exam_in_progress')){
    if(!confirm('Admin area will abandon current exam. Continue?')) return;
    endExamSession();
  }

  // Check if admin is logged in
  const isLoggedIn = sessionStorage.getItem('is_admin_logged_in') === 'true';
  if(isLoggedIn){
    el('adminPanel').classList.remove('hidden');
  } else {
    el('adminPanel').classList.add('hidden');
  }
  show(adminPage);
});
el('toStudentSelect').addEventListener('click', ()=>{ populateStudentSelect(); show(page2); });

function populateStudentSelect(){
  const sel = el('studentSelect'); sel.innerHTML='';
  const placeholder = document.createElement('option'); placeholder.value=''; placeholder.textContent='-- Select Student --'; sel.appendChild(placeholder);
  STUDENTS.forEach(s=>{ const o=document.createElement('option'); o.value=s.examNo; o.textContent=`${s.name} â€” ${s.examNo} (${s.stream})`; sel.appendChild(o); });
}

el('toHomeFromStudents').addEventListener('click', ()=> show(page1));
el('toSubjectPage').addEventListener('click', ()=>{
  const sel = el('studentSelect'); if(!sel.value){ alert('Select a student'); return; }
  const stu = STUDENTS.find(x=>x.examNo===sel.value);
  sessionStorage.setItem('currentStudent', JSON.stringify(stu));
  el('selectedStudentName').textContent = stu.name;
  el('selectedExamNo').textContent = stu.examNo;
  el('studentStream').textContent = stu.stream;
  const subjSel = el('subjectSelect'); subjSel.innerHTML=''; const placeholder=document.createElement('option'); placeholder.value=''; placeholder.textContent='-- Select Subject --'; subjSel.appendChild(placeholder);
  const list = (stu.stream === 'Science') ? SCIENCE_SUBJECTS : SOCIAL_SUBJECTS;
  list.forEach(s=>{const o=document.createElement('option'); o.value=s; o.textContent=s; subjSel.appendChild(o);});
  show(page3);
});

el('backToStudents').addEventListener('click', ()=> show(page2));

/* Exam begin */
el('beginExam').addEventListener('click', async () => {
  const subj = el('subjectSelect').value;
  if (!subj) { alert('Select subject'); return; }

  const stu = JSON.parse(sessionStorage.getItem('currentStudent'));

  // ðŸ”¹ Load exam settings
  const settings = JSON.parse(localStorage.getItem('exam_settings') || '{}');
  const config = settings[subj] || { attempts: 1, duration: 30, date: '' };

  // ðŸ”¸ Normalize and check date restriction
  if (config.date) {
    const today = new Date().toISOString().split('T')[0];  // e.g. "2025-11-07"
    const examDate = config.date.trim();
    if (today !== examDate) {
      alert(`âŒ You cannot take ${subj} today.\nExam is scheduled for ${examDate}.`);
      return;
    }
  }

  // ðŸ”¸ Check attempt restriction
  let results = [];
  if (db) {
    try { results = await fetchResultsForExamNo(stu.examNo) || []; }
    catch (e) { console.warn('Error checking attempts', e); }
  } else {
    results = JSON.parse(localStorage.getItem('sss_results_v1') || '[]');
  }

  const attemptsUsed = results.filter(r => r.examNo === stu.examNo && r.subject === subj).length;
  if (attemptsUsed >= (config.attempts || 1)) {
    alert(`âŒ You have already used all ${config.attempts} attempt(s) for ${subj}.`);
    return;
  }

  // ðŸ”¹ Load questions
  let pool = QUESTIONS_DB[subj] || [];
  if (db) {
    const all = await fetchAllQuestionsFromFirestore();
    if (all && all.length) {
      pool = all.filter(q => (q.subject === subj) && (q.stream === 'Both' || q.stream === stu.stream));
    }
  }

  if (pool.length === 0) {
    alert('âš ï¸ No questions available for this subject.');
    return;
  }

  // ðŸ”¹ Shuffle & prepare
  const selected = shuffleArray(pool).slice(0, Math.min(20, pool.length));
  const examState = {
    student: stu,
    subject: subj,
    examNo: stu.examNo,
    questions: selected.map(q => ({
      q: q.q || q.question || ('No question'),
      options: q.options || q.optionsArr || ['A', 'B', 'C', 'D'],
      answer: typeof q.answer !== 'undefined' ? q.answer : null
    })),
    answers: Array(selected.length).fill(null),
    started: false,
    startTimestamp: null,
    durationSeconds: (config.duration || 30) * 60
  };

  // ðŸ”¹ Save and start exam
  sessionStorage.setItem('examState', JSON.stringify(examState));
  startExam();
  show(page4);
});

/* exam UI */
let examTimer = null, currentBlockStart = 0;
function startExam(){ const state = JSON.parse(sessionStorage.getItem('examState')); if(!state) return; state.started = true; state.startTimestamp = Date.now(); sessionStorage.setItem('examState', JSON.stringify(state)); sessionStorage.setItem('exam_in_progress', '1');
  el('examStudentName').textContent = state.student.name; el('examStudentNo').textContent = state.examNo; el('examSubjectTitle').textContent = state.subject;
  renderNavigator(); renderBlock(0); startTimer(); }
function endExamSession(){ sessionStorage.removeItem('examState'); sessionStorage.removeItem('currentStudent'); sessionStorage.removeItem('currentSubject'); sessionStorage.removeItem('exam_in_progress'); if(examTimer) clearInterval(examTimer); }
function renderNavigator(){ const state = JSON.parse(sessionStorage.getItem('examState')); const nav = el('qnav'); nav.innerHTML=''; if(!state) return; for(let i=0;i<state.questions.length;i++){ const b=document.createElement('div'); b.className='qbox'+(state.answers[i]!==null? ' answered':''); b.textContent = i+1; b.dataset.index = i; b.addEventListener('click', ()=>{ renderBlock(Math.floor(i/5)*5); }); nav.appendChild(b); } }
function renderBlock(start){ currentBlockStart = start; const state = JSON.parse(sessionStorage.getItem('examState')); const area = el('questionArea'); area.innerHTML=''; if(!state) return; const per=5; for(let i=0;i<per;i++){ const qi = start + i; if(qi >= state.questions.length) break; const q = state.questions[qi]; const div = document.createElement('div'); div.className='q'; const qnum = document.createElement('div'); qnum.style.fontWeight='700'; qnum.textContent = `Question ${qi+1}`; const qtext = document.createElement('div'); qtext.textContent = q ? q.q : 'No question uploaded'; div.appendChild(qnum); div.appendChild(qtext);
    const opts = document.createElement('div'); opts.style.marginTop='8px'; if(q && q.options){ q.options.forEach((op, idx)=>{ const label = document.createElement('label'); label.style.display='block'; label.style.padding='8px'; label.style.border='1px solid #eef5ff'; label.style.borderRadius='8px'; label.style.marginBottom='6px'; const input = document.createElement('input'); input.type='radio'; input.name = `q_${qi}`; input.checked = (state.answers[qi] === idx); input.addEventListener('change', ()=>{ state.answers[qi] = idx; sessionStorage.setItem('examState', JSON.stringify(state)); renderNavigator(); }); label.appendChild(input); label.appendChild(document.createTextNode(' '+op)); opts.appendChild(label); }); } else { opts.innerHTML = '<div class=\"small\">No options available.</div>'; }
    div.appendChild(opts); area.appendChild(div);
  }
  document.querySelectorAll('#qnav .qbox').forEach((b, idx)=>{ b.classList.toggle('current', idx>=start && idx<start+per); });
}
el('nextBlock').addEventListener('click', ()=>{ const state = JSON.parse(sessionStorage.getItem('examState')); const per=5; if(currentBlockStart+per < state.questions.length) renderBlock(currentBlockStart+per); });
el('prevBlock').addEventListener('click', ()=>{ const per=5; if(currentBlockStart-per >= 0) renderBlock(currentBlockStart-per); });
function startTimer(){ if(examTimer) clearInterval(examTimer); examTimer = setInterval(()=>{ const state = JSON.parse(sessionStorage.getItem('examState')); if(!state){ clearInterval(examTimer); return; } const elapsed = Math.floor((Date.now() - state.startTimestamp)/1000); const remaining = Math.max(0, state.durationSeconds - elapsed); const mm = String(Math.floor(remaining/60)).padStart(2,'0'); const ss = String(remaining%60).padStart(2,'0'); el('timerDisplay').textContent = `${mm}:${ss}`; if(remaining <= 0){ clearInterval(examTimer); alert('Time is up. Your exam will be submitted automatically.'); submitExam(true); } }, 500); }

/* Submit: now saves to Firestore results collection (or fallback local if no Firebase) */
el('submitExam').addEventListener('click', ()=>{ if(!confirm('Submit exam now?')) return; submitExam(false); });
async function submitExam(isAuto){
  const state = JSON.parse(sessionStorage.getItem('examState')); if(!state) return;
  let correct = 0; for(let i=0;i<state.questions.length;i++){ const q = state.questions[i]; if(state.answers[i] !== null && typeof q.answer !== 'undefined' && state.answers[i] === q.answer) correct++; }
  const total = state.questions.length; const score = Math.round((correct/total)*100);

  // build result object
  const result = {
    studentName: state.student.name,
    examNo: state.examNo,
    subject: state.subject,
    score,
    correct,
    total,
    timestamp: new Date().toISOString(),
    stream: state.student.stream
  };

  try {
    if(db){
      await saveResultToFirestore(result);
    } else {
      // fallback localStorage results
      const results = JSON.parse(localStorage.getItem('sss_results_v1') || '[]');
      results.push(result);
      localStorage.setItem('sss_results_v1', JSON.stringify(results));
    }
    endExamSession();
    alert('Exam submitted. Your score: ' + score + '%');
    populateStudentSelect(); show(page2);
  } catch (e){
    console.error(e);
    alert('Error saving result: ' + e.message);
  }
}

/* ---- Admin logic (clean login/logout interface + auto logout on Home) ---- */

// Handle login
el('adminLogin').addEventListener('click', async ()=>{
  const u = el('adminUser').value.trim();
  const p = el('adminPass').value.trim();

  if (u === ADMIN_CRED.user && p === ADMIN_CRED.pass) {
    sessionStorage.setItem('is_admin_logged_in', 'true');
    el('adminPanel').classList.remove('hidden');
    el('adminLoginSection').classList.add('hidden');       // âœ… hide login area
    el('adminLogoutSection').classList.remove('hidden');   // âœ… show logout buttons
    await populateAdmin();
    populateAddQuestionSubjects();
    alert('âœ… Admin login successful!');
  } else {
    alert('âŒ Invalid credentials');
  }
});

// Handle logout (when Logout button clicked)
el('adminLogout').addEventListener('click', ()=>{
  sessionStorage.removeItem('is_admin_logged_in');
  el('adminPanel').classList.add('hidden');
  el('adminLoginSection').classList.remove('hidden');     // âœ… show login again
  el('adminLogoutSection').classList.add('hidden');       // âœ… hide logout buttons

  // âœ… clear credentials from inputs
  el('adminUser').value = '';
  el('adminPass').value = '';

  alert('âœ… Logged out successfully.');
  show(page1);
});

// Handle both Back buttons
el('adminBack').addEventListener('click', ()=> {
  sessionStorage.removeItem('is_admin_logged_in');
  el('adminPanel').classList.add('hidden');
  el('adminLoginSection').classList.remove('hidden');
  el('adminLogoutSection').classList.add('hidden');
  el('adminUser').value = '';
  el('adminPass').value = '';
  show(page1);
});
el('adminBack2').addEventListener('click', ()=> {
  sessionStorage.removeItem('is_admin_logged_in');
  el('adminPanel').classList.add('hidden');
  el('adminLoginSection').classList.remove('hidden');
  el('adminLogoutSection').classList.add('hidden');
  el('adminUser').value = '';
  el('adminPass').value = '';
  show(page1);
});

// When Admin page is opened
el('adminBtn').addEventListener('click', ()=>{
  if(sessionStorage.getItem('exam_in_progress')){
    if(!confirm('Admin area will abandon current exam. Continue?')) return;
    endExamSession();
  }

  const isLoggedIn = sessionStorage.getItem('is_admin_logged_in') === 'true';
  if(isLoggedIn){
    el('adminPanel').classList.remove('hidden');
    el('adminLoginSection').classList.add('hidden');
    el('adminLogoutSection').classList.remove('hidden');
  } else {
    el('adminPanel').classList.add('hidden');
    el('adminLoginSection').classList.remove('hidden');
    el('adminLogoutSection').classList.add('hidden');
  }
  show(adminPage);
});

// âœ… HOME BUTTON: Automatically logs out admin if logged in
el('homeBtn').addEventListener('click', ()=> {
  // If admin session exists, clear it
  if (sessionStorage.getItem('is_admin_logged_in')) {
    sessionStorage.removeItem('is_admin_logged_in');
    el('adminPanel').classList.add('hidden');
    el('adminLoginSection').classList.remove('hidden');
    el('adminLogoutSection').classList.add('hidden');
    el('adminUser').value = '';
    el('adminPass').value = '';
    console.log('Admin session cleared due to Home click.');
  }
  show(page1);
});

/* Admin: add student */
el('addStudentBtn').addEventListener('click', async ()=>{
  const name = el('newStudentName').value.trim();
  const stream = el('newStudentStream').value;

  if (!name || !examNo) return alert('Provide name and exam number');

  // âœ… Auto-generate exam number
  const examNo = getNextExamNumber(stream);

  const newStudent = { name, examNo, stream };

  // âœ… Add to memory
  STUDENTS.push(newStudent);

  // âœ… Save to Firestore if enabled
  if (db) {
    try {
      await saveStudentToFirestore(newStudent);
    } catch (e) {
      console.error(e);
      alert('Error saving student to Firestore');
    }
  } else {
    // Optional: persist locally too
    localStorage.setItem('sss_students_v1', JSON.stringify(STUDENTS));
  }

  // âœ… Clear inputs
  el('newStudentName').value = '';
  el('newStudentStream').value = '';
  el('newStudentExamNo').value = '';

  // âœ… Refresh both student dropdowns everywhere
  await populateAdmin();          // refresh result-check dropdown
  populateStudentSelect();        // refresh exam student dropdown

  // âœ… Confirm success
  alert('âœ… Student added successfully!');

  console.log('Updated STUDENTS:', STUDENTS);
});

/* Admin: add question */
el('addQuestionBtn').addEventListener('click', async ()=>{
  const subject = el('addQSubject').value;
  const stream = el('addQStream').value;
  const qtext = el('newQuestionText').value.trim();
  const options = [el('optA').value, el('optB').value, el('optC').value, el('optD').value];
  const answer = parseInt(el('correctOption').value, 10);
  if(!qtext || options.some(o=>!o)) return alert('Provide question and all options');
  const qObj = { subject, stream, q: qtext, options, answer };
  if(db){
    try { await saveQuestionToFirestore(qObj); } catch(e){ console.error(e); alert('Error saving question to Firestore'); }
  } else {
    if(!QUESTIONS_DB[subject]) QUESTIONS_DB[subject]=[];
    QUESTIONS_DB[subject].push(qObj);
  }
  el('newQuestionText').value=''; el('optA').value=''; el('optB').value=''; el('optC').value=''; el('optD').value='';
  alert('Question added');
});

/* =============== RESET SINGLE SUBJECT ATTEMPT LOGIC =============== */

// Function to populate the subject dropdown
function populateResetSubjectList() {
  const subjectSel = document.getElementById('resetSubjectSelect');
  if (!subjectSel) return;

  // Clear dropdown
  subjectSel.innerHTML = '<option value="">-- Select Subject to Reset --</option>';

  // Get subjects from multiple sources
  const sci = typeof SCIENCE_SUBJECTS !== 'undefined' ? SCIENCE_SUBJECTS : [];
  const soc = typeof SOCIAL_SUBJECTS !== 'undefined' ? SOCIAL_SUBJECTS : [];
  
  // Also check QUESTIONS_DB for subjects
  const dbSubjects = typeof QUESTIONS_DB !== 'undefined' ? Object.keys(QUESTIONS_DB) : [];
  
  const subjects = [...new Set([...sci, ...soc, ...dbSubjects])]; // Combine all sources

  if (subjects.length === 0) {
    console.warn('âš ï¸ No subjects found. Check that subject arrays are defined.');
    return;
  }

  // Sort subjects alphabetically for better UX
  subjects.sort().forEach(sub => {
    const opt = document.createElement('option');
    opt.value = sub;
    opt.textContent = sub;
    subjectSel.appendChild(opt);
  });
}

/* Admin: populate student dropdowns and results table */
async function populateAdmin(){
  // load students from firestore if available
  if(db){
    try {
      const studentsFromDb = await fetchAllStudentsFromFirestore();
      if(studentsFromDb && studentsFromDb.length) STUDENTS = studentsFromDb;
    } catch(e){ console.error('Unable to fetch students from Firestore', e); }
  }
  const sel = el('adminStudentSelect'); sel.innerHTML=''; const placeholder=document.createElement('option'); placeholder.value=''; placeholder.textContent='-- Select Student --'; sel.appendChild(placeholder);
  STUDENTS.forEach(s=>{ const o=document.createElement('option'); o.value=s.examNo; o.textContent = `${s.name} â€” ${s.examNo}`; sel.appendChild(o); });
  renderResultsTable();
  populateResetSubjectList(); // âœ… Load the subjects dropdown
}

async function renderResultsTable(){
  const container = el('resultsTable');
  let results = [];
  if(db){
    try { results = await fetchAllResults(); } catch(e){ console.error(e); }
  } else {
    results = JSON.parse(localStorage.getItem('sss_results_v1') || '[]');
  }
  if(!results || results.length === 0){ container.innerHTML = '<div class="small">No results yet.</div>'; return; }
  const byStudent = {};
  results.forEach(r=>{ if(!byStudent[r.examNo]) byStudent[r.examNo] = {info:{name:r.studentName, examNo:r.examNo, stream:r.stream}, subjects:[]}; byStudent[r.examNo].subjects.push(r); });
  let html = '<table style="width:100%;border-collapse:collapse"><thead><tr><th style="text-align:left">Student</th><th>Stream</th><th>Subjects</th><th>Avg (%)</th></tr></thead><tbody>';
  Object.values(byStudent).forEach(s=>{ const avg = (s.subjects.reduce((a,b)=>a+b.score,0)/s.subjects.length).toFixed(2); html += `<tr><td>${s.info.name}<div class="small">${s.info.examNo}</div></td><td>${s.info.stream}</td><td>${s.subjects.length}</td><td>${avg}</td></tr>`; });
  html += '</tbody></table>';
  container.innerHTML = html;
}

/* download single student pdf */
el('downloadResultPdf').addEventListener('click', async ()=>{
  const examNo = el('adminStudentSelect').value; if(!examNo) return alert('Select a student first');
  const stu = STUDENTS.find(s=>s.examNo===examNo); if(!stu) return alert('Student not found');

  // fetch results for this student
  let results = [];
  if(db){
    try { results = await fetchResultsForExamNo(examNo); } catch(e){ console.error(e); }
  } else results = JSON.parse(localStorage.getItem('sss_results_v1')||'[]').filter(r=>r.examNo===examNo);
  if(!results || results.length===0) return alert('No results for this student');

  const avg = (results.reduce((a,b)=>a+b.score,0)/results.length).toFixed(2);
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','mm','a4');
  const logo = new Image();
  logo.src = logoPath;
  // wait for logo to load then generate
  logo.onload = function(){
    doc.addImage(logo, "PNG", 14, 10, 24, 24);
    doc.setFont("times","bold");
    doc.setTextColor(0,0,128);
    doc.setFontSize(16);
    doc.text("SIMPLE STANDARD SCHOOL, JOS", 105, 20, {align:"center"});
    doc.setFontSize(12);
    doc.setTextColor(0,0,0);
    doc.text("SS3 Examination Report", 105, 28, {align:"center"});
    doc.line(14, 32, 196, 32);

    // student info
    doc.setFontSize(11);
    doc.text(`Student Name: ${stu.name}`, 14, 40);
    doc.text(`Exam Number: ${stu.examNo}`, 14, 48);
    doc.text(`Field/Stream: ${stu.stream}`, 14, 56);
    doc.text(`Date: ${new Date().toLocaleDateString()}`, 14, 64);

    // table
    let y = 76;
    doc.setFont("times","bold");
    doc.text("Subjects and Scores", 14, y);
    y+=6;
    doc.setFont("times","normal");
    results.forEach(r=>{
      doc.text(`${r.subject}: ${r.score}% (${r.correct}/${r.total})`, 14, y);
      y+=8;
      if(y>270){ doc.addPage(); y=20; }
    });

    y+=8;
    doc.setFont("times","bold");
    doc.text(`Average: ${avg}%`, 14, y);
    y+=8;
    const grade = avg >= 70 ? "A (Excellent)" : avg >= 60 ? "B" : avg >=50 ? "C" : avg >=40 ? "D" : avg>=35? "E":"F";
    doc.text(`Grade: ${grade}`, 14, y);
    y+=8;
    const remark = avg >= 70 ? "Excellent" : avg >=60 ? "Very good" : avg>=50 ? "Good" : avg>=40 ? "Pass" : "Needs improvement";
    doc.text(`Remark: ${remark}`, 14, y);

    doc.save(`${stu.name.replace(/\s+/g,'_')}_result.pdf`);
  };
  logo.onerror = function(){ alert('Logo could not be loaded. Check logo.png exists'); };
});

/* export all results as JSON */
el('exportAllJson').addEventListener('click', async ()=>{

// Make sure dropdown is populated when Admin page loads
document.addEventListener('DOMContentLoaded', () => {
  populateResetSubjectList();
});

// Also repopulate every time admin panel is opened
if (document.getElementById('adminLoginBtn')) {
  document.getElementById('adminLoginBtn').addEventListener('click', () => {
    setTimeout(populateResetSubjectList, 300);
  });
}

  let data = [];
  if(db){ data = await fetchAllResults(); } else data = JSON.parse(localStorage.getItem('sss_results_v1') || '[]');
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'sss_all_results.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

/* Utilities */
function shuffleArray(a){ const arr = a.slice(); for(let i=arr.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; }
window.addEventListener('beforeunload', (e)=>{ if(sessionStorage.getItem('exam_in_progress')){ e.preventDefault(); e.returnValue = ''; } });

/* Initialization: load students/questions from Firestore if available */
(async function init(){
  if(db){
    try {
      const studentsFromDb = await fetchAllStudentsFromFirestore();
      if(studentsFromDb && studentsFromDb.length) STUDENTS = studentsFromDb;
      const questionsFromDb = await fetchAllQuestionsFromFirestore();
      if(questionsFromDb && questionsFromDb.length){
        QUESTIONS_DB = {}; // re-build grouped by subject
        questionsFromDb.forEach(q=>{
          if(!QUESTIONS_DB[q.subject]) QUESTIONS_DB[q.subject]=[];
          QUESTIONS_DB[q.subject].push(q);
        });
      }
    } catch(e){ console.warn('Error preloading from Firestore', e); }
  } else {
    // fallback: generate dummy MCQs automatically for each subject if none exist
    [...SCIENCE_SUBJECTS, ...SOCIAL_SUBJECTS].forEach(s=>{
      if(!QUESTIONS_DB[s] || QUESTIONS_DB[s].length===0){
        const qs = [];
        for(let i=1;i<=40;i++){
          qs.push({subject:s, stream:'Both', q:`(${s}) Q${i}: Which option is correct for question ${i}?`, options:[`A. option A`,`B. option B`,`C. option C`,`D. option D`], answer: Math.floor(Math.random()*4)});
        }
        QUESTIONS_DB[s] = qs;
      }
    });
  }
  populateStudentSelect();
})();

/* View Student Result (HTML Page) */
el('viewResultBtn').addEventListener('click', async () => {
  const examNo = el('adminStudentSelect').value;
  if (!examNo) return alert('Select a student first');
  const stu = STUDENTS.find(s => s.examNo === examNo);
  if (!stu) return alert('Student not found');

  // Fetch results
  let results = [];
  if (db) {
    try { results = await fetchResultsForExamNo(examNo); } catch (e) { console.error(e); }
  } else {
    results = JSON.parse(localStorage.getItem('sss_results_v1') || '[]').filter(r => r.examNo === examNo);
  }

  if (!results.length) return alert('No results found for this student');

  // Compute average
  const avg = (results.reduce((a, b) => a + b.score, 0) / results.length).toFixed(2);
  const grade = avg >= 70 ? "A (Excellent)" : avg >= 60 ? "B" : avg >= 50 ? "C" : avg >= 40 ? "D" : avg >= 35 ? "E" : "F";
  const remark = avg >= 70 ? "Excellent" : avg >= 60 ? "Very Good" : avg >= 50 ? "Good" : avg >= 40 ? "Pass" : "Needs Improvement";

  // Build new tab content
  const win = window.open('', '_blank');
  win.document.write(`
    <html>
    <head>
      <title>Student Result - ${stu.name}</title>
      <style>
        body { font-family: 'Times New Roman', serif; margin: 30px; color: #000; }
        .header { text-align: center; }
        .header img { width: 80px; height: 80px; object-fit: contain; }
        .school-name { font-family: 'Cooper Black', serif; color: navy; font-size: 22px; font-weight: bold; text-transform: uppercase; }
        h2 { text-align: center; text-transform: uppercase; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #333; padding: 8px; text-align: center; }
        th { background-color: #f0f0f0; }
        .info { margin-top: 20px; font-size: 14px; }
        .footer { margin-top: 20px; font-weight: bold; }
        .print-btn { margin-top: 25px; padding: 10px 20px; background: navy; color: white; border: none; border-radius: 5px; cursor: pointer; }
        @page { size: A4; margin: 20mm; }
      </style>
    </head>
    <body>
      <div class="header">
        <img src="./logo.png" alt="School Logo"><br>
        <div class="school-name">SIMPLE STANDARD SCHOOL, JOS</div>
        <h2>STUDENT RESULT</h2>
      </div>

      <div class="info">
        <strong>Student Name:</strong> ${stu.name}<br>
        <strong>Exam Number:</strong> ${stu.examNo}<br>
        <strong>Stream:</strong> ${stu.stream}<br>
        <strong>Date:</strong> ${new Date().toLocaleDateString()}
      </div>

      <table>
        <tr><th>Subject</th><th>Score (%)</th><th>Grade</th></tr>
        ${results.map(r => `<tr><td>${r.subject}</td><td>${r.score}</td><td>${r.score >= 70 ? 'A' : r.score >= 60 ? 'B' : r.score >= 50 ? 'C' : r.score >= 40 ? 'D' : r.score >= 35 ? 'E' : 'F'}</td></tr>`).join('')}
      </table>

      <div class="footer">
        <p>Average Score: ${avg}%</p>
        <p>Grade: ${grade}</p>
        <p>Remark: ${remark}</p>
      </div>

      <div style="text-align:center;">
        <button class="print-btn" onclick="window.print()">Print Result</button>
      </div>
    </body>
    </html>
  `);
  win.document.close();
});

/* ===================== FIXED EXAM DETAILS LOGIC ===================== */

// When the admin clicks "Exam Details" button
el('examDetailsBtn').addEventListener('click', () => {
  populateExamDetailsTable();   // build the table dynamically
  show(el('examDetailsPage'));  // show the page
});

// Back button
el('backToAdmin').addEventListener('click', () => {
  show(el('admin'));
});

// Back button from Edit Questions page
el('backFromEdit').addEventListener('click', () => {
  show(el('admin'));
});

// Save button â€” saves settings to localStorage
el('saveExamDetails').addEventListener('click', () => {
  const settings = {};

  // collect values from table rows
  document.querySelectorAll('#examDetailsTable tr[data-subject]').forEach(row => {
    const subj = row.dataset.subject;
    const attempts = parseInt(row.querySelector('.attempt').value) || 1;
    const duration = parseInt(row.querySelector('.duration').value) || 30;
    const date = row.querySelector('.date').value || '';
    settings[subj] = { attempts, duration, date };
  });

  // save to localStorage
  localStorage.setItem('exam_settings', JSON.stringify(settings));
  alert('âœ… Exam details saved successfully!');
  show(el('admin'));
});

// Build table dynamically and load previous settings
function populateExamDetailsTable() {
  const table = el('examDetailsTable');
  const settings = JSON.parse(localStorage.getItem('exam_settings') || '{}');
  const subjects = [...new Set([...SCIENCE_SUBJECTS, ...SOCIAL_SUBJECTS])];

  // Create table rows
  const rows = subjects.map(subj => {
    const config = settings[subj] || {};
    return `
      <tr data-subject="${subj}">
        <td>${subj}</td>
        <td><input type="number" class="attempt" min="1" max="10" value="${config.attempts || 1}"></td>
        <td><input type="number" class="duration" min="5" max="180" value="${config.duration || 30}"></td>
        <td><input type="date" class="date" value="${config.date || ''}"></td>
      </tr>
    `;
  }).join('');

  // Rebuild the table (preserve header)
  table.innerHTML = `
    <tr>
      <th>Subject</th>
      <th>Max Attempts</th>
      <th>Duration (Minutes)</th>
      <th>Exam Date</th>
    </tr>
    ${rows}
  `;
}

/* ==================== RESET SUBJECT ATTEMPT FIX ==================== */
document.addEventListener('DOMContentLoaded', () => {
  const resetBtn = document.getElementById('resetSubjectBtn');
  if (!resetBtn) return;

  resetBtn.addEventListener('click', async () => {   // âœ… add "async" here
    const examNo = document.getElementById('adminStudentSelect').value;
    const subject = document.getElementById('resetSubjectSelect').value;

    if (!examNo) return alert('âŒ Please select a student first.');
    if (!subject) return alert('âŒ Please select a subject to reset.');

    const confirmReset = confirm(`âš ï¸ This will delete "${subject}" exam attempt for student ${examNo}. Continue?`);
    if (!confirmReset) return;

    let results = [];

    if (db) {
      try { 
        results = await fetchAllResults();   // now valid
      } catch (e) { 
        console.warn("Error fetching from Firestore", e); 
      }
    } else {
      results = JSON.parse(localStorage.getItem('sss_results_v1') || '[]');
    }

    const beforeCount = results.length;
    results = results.filter(r => !(r.examNo === examNo && r.subject === subject));
    const removed = beforeCount - results.length;
    localStorage.setItem('sss_results_v1', JSON.stringify(results));

    if (removed > 0) {
      alert(`âœ… Successfully cleared "${subject}" attempt for student ${examNo}.`);
      renderResultsTable();
    } else {
      alert(`âš ï¸ No "${subject}" exam record found for student ${examNo}.`);
    }
  });
});

/* ========== EDIT QUESTIONS FEATURE ========== */
const editSubjectSelect = el('editSubjectSelect');
const questionListContainer = el('questionListContainer');

el('editQuestionsBtn').addEventListener('click', async ()=>{
  await loadSubjectsToEdit();
  questionListContainer.innerHTML = '';
  show(editQuestionsPage);
});

async function loadSubjectsToEdit() {
  editSubjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
  const subjects = Object.keys(QUESTIONS_DB || {});
  subjects.forEach(subj => {
    const opt = document.createElement('option');
    opt.value = subj;
    opt.textContent = subj;
    editSubjectSelect.appendChild(opt);
  });
}

editSubjectSelect.addEventListener('change', ()=>{
  const subj = editSubjectSelect.value;
  if(!subj) { questionListContainer.innerHTML = ''; return; }

  const qs = QUESTIONS_DB[subj] || [];
  if(!qs.length){
    questionListContainer.innerHTML = '<p>No questions found for this subject.</p>';
    return;
  }

  let html = '';
  qs.forEach((q, i)=>{
    html += `
      <div class="card" style="margin-top:12px;padding:10px;">
        <label>Question ${i+1}</label>
        <textarea data-qindex="${i}" class="q-text" style="width:100%;height:60px;">${q.q}</textarea>
        <label>Options:</label>
        ${q.options.map((opt, j)=>`
          <input data-qindex="${i}" data-oindex="${j}" class="q-option" style="width:100%;margin-bottom:5px;" value="${opt}">
        `).join('')}
        <label>Correct Answer</label>
        <input data-qindex="${i}" class="q-answer" style="width:100%;" value="${q.answer}">
      </div>
    `;
  });

  questionListContainer.innerHTML = html;
});

el('saveQuestionChanges').addEventListener('click', async ()=>{
  const subj = editSubjectSelect.value;
  if(!subj) return alert('Select a subject first');

  const qs = QUESTIONS_DB[subj] || [];
  document.querySelectorAll('.q-text').forEach(t=>{
    const i = +t.dataset.qindex;
    if(qs[i]) qs[i].question = t.value.trim();
  });
  document.querySelectorAll('.q-option').forEach(o=>{
    const i = +o.dataset.qindex, j = +o.dataset.oindex;
    if(qs[i]) qs[i].options[j] = o.value.trim();
  });
  document.querySelectorAll('.q-answer').forEach(a=>{
    const i = +a.dataset.qindex;
    if(qs[i]) qs[i].answer = a.value.trim();
  });

  if(db){
    try {
      await saveQuestionsToFirestore(subj, qs);
      alert('âœ… Questions updated successfully.');
    } catch(e){
      console.error(e);
      alert('Error updating questions.');
    }
  }

  QUESTIONS_DB[subj] = qs;
  await populateAdmin();
});

el('backFromEdit').addEventListener('click', ()=> show(adminPage));
async function saveQuestionsToFirestore(subject, questions){
  const ref = doc(db, 'exam_subjects', subject);
  await setDoc(ref, { questions }, { merge:true });
}

</script>
</body>
</html>
